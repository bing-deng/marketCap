import requests
from urllib.request import urlopen,Request
import json
from datetime import datetime
import xlwt
import time
data = xlwt.Workbook()



class Btcbox():
    
    def __init__(self,coin):
        # lower 
        self.coin = coin
        self.table = data.add_sheet(coin)
        self.table.write(0,1,u'open')
        self.table.write(0,2,u'close')
        self.table.write(0,3,u'high')
        self.table.write(0,4,u'low')
        self.table.write(0,5,u'volume')

    def data(self):

        # 时间戳 https://www.unixtimestamp.com/
        #  https://www.btcbox.co.jp/index/tradingview/kline/coin/eth/type/history?symbol=AAPL&resolution=D&from=1625077576&to=1627788376
        to_time = time.time()
        from_time = time.time() - 31* 24* 60*60

        btc_url = "https://www.btcbox.co.jp/index/tradingview/kline/coin/btc/type/history?symbol=AAPL&resolution=D&from="+ str(from_time)+"&to="+str(to_time)
        eth_url = "https://www.btcbox.co.jp/index/tradingview/kline/coin/eth/type/history?symbol=AAPL&resolution=D&from="+ str(from_time)+"&to="+str(to_time)
        ltc_url = "https://www.btcbox.co.jp/index/tradingview/kline/coin/ltc/type/history?symbol=AAPL&resolution=D&from="+ str(from_time)+"&to="+str(to_time)
        bch_url = "https://www.btcbox.co.jp/index/tradingview/kline/coin/bch/type/history?symbol=AAPL&resolution=D&from="+ str(from_time)+"&to="+str(to_time)
        # # r = requests.get(url).json()
        # headers = {'User-Agent':'Mozilla/5.0 (Windows NT 6.1; WOW64; rv:23.0) Gecko/20100101 Firefox/23.0'}
        # req = Request(url=url, headers=headers)
        # html = urlopen(req).read()
        # print(html)
        print(btc_url)
        btc = requests.get(btc_url).json()
        eth = requests.get(eth_url).json()
        bch = requests.get(bch_url).json()
        ltc = requests.get(ltc_url).json()
        # eth = '{"t":[1624892400,1624978800,1625065200,1625151600,1625238000,1625324400,1625410800,1625497200,1625583600,1625670000,1625756400,1625842800,1625929200,1626015600,1626102000,1626188400,1626274800,1626361200,1626447600,1626534000,1626620400,1626706800,1626793200,1626879600,1626966000,1627052400,1627138800,1627225200,1627311600,1627398000,1627484400,1627570800,1627657200,1627743600],"c":["245877.00000000","235932.00000000","233143.00000000","235789.00000000","247744.00000000","257789.00000000","247656.00000000","255112.00000000","260289.00000000","236693.00000000","240853.00000000","232825.00000000","236629.00000000","231661.00000000","218142.00000000","221897.00000000","211390.00000000","210512.00000000","207411.00000000","210111.00000000","199583.00000000","194563.00000000","213390.00000000","220103.00000000","228277.00000000","239573.00000000","233596.00000000","256711.00000000","250537.00000000","251991.00000000","254432.00000000","257540.00000000","268154.00000000","287734.0000000000"],"o":["226611","245877","235922","233143","235924","247744","257725","247648","255341","260928","236693","240828","232825","236615","231661","218121","221897","211389","210512","207390","210191","199584","194560","213511","220111","228277","239582","233591","256711","250331","251870","254451","257610","268154.0000000000"],"h":["247021.00000000","247114.00000000","254147.00000000","238810.00000000","248765.00000000","260599.00000000","264996.00000000","259996.00000000","265843.00000000","262496.00000000","241210.00000000","241431.00000000","237987.00000000","239518.00000000","231805.00000000","222560.00000000","224188.00000000","216012.00000000","213961.00000000","219602.00000000","212411.00000000","201900.00000000","213733.00000000","224154.00000000","230000.00000000","239991.00000000","243111.00000000","263312.00000000","265479.00000000","257750.00000000","256201.00000000","268310.00000000","271140.00000000","287875.0000000000"],"l":["226590.00000000","230645.00000000","231365.00000000","225195.00000000","231292.00000000","242989.00000000","242822.00000000","240000.00000000","251730.00000000","233898.00000000","225429.00000000","230000.00000000","228865.00000000","230742.00000000","216990.00000000","205868.00000000","207922.00000000","203907.00000000","203904.00000000","206244.00000000","197427.00000000","188195.00000000","193289.00000000","212792.00000000","217041.00000000","220669.00000000","220000.00000000","233271.00000000","236339.00000000","240737.00000000","248470.00000000","251370.00000000","256401.00000000","267128.0000000000"],"v":["885.10270000","864.07410000","963.17450000","995.73850000","1080.75930000","1101.56360000","1057.27110000","1018.73130000","995.59890000","782.20140000","1073.80860000","1108.18610000","1095.76140000","1096.48750000","1097.80170000","1031.03330000","1053.27830000","1079.25320000","1088.65890000","1096.47630000","1071.40200000","1077.22570000","1076.18460000","997.30600000","1074.29250000","944.20890000","893.25510000","965.72370000","833.43850000","896.81400000","840.02470000","887.47560000","611.02410000","283.34070000"],"s":"ok"}'
        # btc = '{"t":[1624892400,1624978800,1625065200,1625151600,1625238000,1625324400,1625410800,1625497200,1625583600,1625670000,1625756400,1625842800,1625929200,1626015600,1626102000,1626188400,1626274800,1626361200,1626447600,1626534000,1626620400,1626706800,1626793200,1626879600,1626966000,1627052400,1627138800,1627225200,1627311600,1627398000,1627484400,1627570800,1627657200,1627743600],"c":["4009621.00000000","3840090.00000000","3702402.00000000","3743889.00000000","3858055.00000000","3938086.00000000","3747540.00000000","3782987.00000000","3833993.00000000","3593980.00000000","3697640.00000000","3726834.00000000","3738489.00000000","3688021.00000000","3596490.00000000","3621867.00000000","3504011.00000000","3510239.00000000","3484226.00000000","3451320.00000000","3376010.00000000","3256432.00000000","3511810.00000000","3553924.00000000","3593328.00000000","3746514.00000000","3768808.00000000","4218176.00000000","4202011.00000000","4352643.00000000","4377845.00000000","4287607.00000000","4537485.00000000","4647970.0000000000"],"o":["3799232","4009600","3840111","3705544","3745917","3853795","3935266","3747540","3772570","3833079","3594111","3697619","3726834","3738489","3688021","3596490","3621846","3503990","3510265","3484226","3451299","3376010","3269715","3511831","3550461","3593307","3745416","3768808","4218155","4201990","4352664","4378158","4287607","4538747.0000000000"],"h":["4029013.00000000","4039990.00000000","3921872.00000000","3790474.00000000","3870363.00000000","3962846.00000000","3990010.00000000","3883749.00000000","3878138.00000000","3852889.00000000","3707877.00000000","3773898.00000000","3766140.00000000","3815991.00000000","3699511.00000000","3638239.00000000","3646993.00000000","3528401.00000000","3551096.00000000","3567999.00000000","3515811.00000000","3398210.00000000","3512542.00000000","3610150.00000000","3623667.00000000","3759090.00000000","3847445.00000000","4420135.00000000","4438085.00000000","4492212.00000000","4464938.00000000","4418406.00000000","4636471.00000000","4669032.0000000000"],"l":["3766258.00000000","3808021.00000000","3692825.00000000","3650005.00000000","3676401.00000000","3808418.00000000","3701684.00000000","3690255.00000000","3720002.00000000","3530774.00000000","3549994.00000000","3669991.00000000","3646618.00000000","3677965.00000000","3573757.00000000","3501659.00000000","3470491.00000000","3418230.00000000","3432502.00000000","3440676.00000000","3333333.00000000","3215004.00000000","3248336.00000000","3477650.00000000","3535403.00000000","3538452.00000000","3729490.00000000","3755953.00000000","4000672.00000000","4100000.00000000","4281000.00000000","4204032.00000000","4271926.00000000","4505953.0000000000"],"v":["1055.97070000","1046.66980000","1049.42910000","1072.71390000","1076.21600000","1051.57760000","1074.66550000","1057.52810000","1051.45840000","1001.22790000","911.37700000","1104.76270000","1114.99690000","1131.44140000","1047.49500000","1138.82030000","1112.96770000","1093.25970000","1065.04860000","1095.39840000","1137.55370000","838.86880000","624.82300000","1113.35650000","1153.24040000","1119.30900000","1036.91700000","948.91670000","838.66590000","892.96710000","972.37610000","997.23340000","1038.26050000","577.69200000"],"s":"ok"}'
        # ltc = '{"t":[1624892400,1624978800,1625065200,1625151600,1625238000,1625324400,1625410800,1625497200,1625583600,1625670000,1625756400,1625842800,1625929200,1626015600,1626102000,1626188400,1626274800,1626361200,1626447600,1626534000,1626620400,1626706800,1626793200,1626879600,1626966000,1627052400,1627138800,1627225200,1627311600,1627398000,1627484400,1627570800,1627657200,1627743600],"c":["16303.00000000","15459.00000000","15097.00000000","15042.00000000","15570.00000000","16142.00000000","15171.00000000","15274.00000000","15588.00000000","14351.00000000","14881.00000000","14597.00000000","14905.00000000","15100.00000000","14511.00000000","14473.00000000","13795.00000000","13623.00000000","13234.00000000","12952.00000000","12398.00000000","11797.00000000","12767.00000000","13177.00000000","13291.00000000","13919.00000000","13760.00000000","15118.00000000","14616.00000000","15139.00000000","15332.00000000","15079.00000000","15756.00000000","16360.0000000000"],"o":["14602","16262","15458","15110","15053","15570","16132","15169","15274","15580","14374","14856","14622","14927","15101","14508","14483","13792","13629","13228","12963","12397","11803","12770","13176","13271","13911","13726","15118","14660","15135","15367","15100","15748.0000000000"],"h":["16479.00000000","19000.00000000","17151.00000000","15510.00000000","15655.00000000","16289.00000000","16459.00000000","15899.00000000","15824.00000000","15630.00000000","15204.00000000","15000.00000000","14985.00000000","15299.00000000","15438.00000000","14868.00000000","14599.00000000","14075.00000000","13829.00000000","13680.00000000","13462.00000000","12619.00000000","12800.00000000","13194.00000000","13475.00000000","14107.00000000","14165.00000000","15427.00000000","15384.00000000","15437.00000000","15678.00000000","15760.00000000","16120.00000000","16439.0000000000"],"l":["14597.00000000","15331.00000000","15050.00000000","14566.00000000","14790.00000000","15202.00000000","15000.00000000","14989.00000000","15091.00000000","14127.00000000","14001.00000000","14460.00000000","14390.00000000","14732.00000000","14400.00000000","13720.00000000","13658.00000000","13293.00000000","13011.00000000","12899.00000000","12221.00000000","11425.00000000","11568.00000000","12719.00000000","13112.00000000","12959.00000000","13644.00000000","13710.00000000","14011.00000000","14424.00000000","14799.00000000","14915.00000000","15029.00000000","15584.0000000000"],"v":["415.39870000","414.65300000","402.27650000","421.63290000","403.99570000","425.55340000","412.65680000","417.66530000","400.08450000","408.77910000","412.80860000","477.69530000","411.18940000","410.85950000","442.31950000","446.48230000","407.37140000","463.12590000","437.81210000","417.75750000","406.27740000","538.99720000","413.96700000","407.70430000","406.39870000","440.35100000","396.86930000","428.95180000","462.17190000","409.81600000","408.68710000","400.96740000","433.43540000","223.75040000"],"s":"ok"}'
        # bch = ''
        # 

        dic = {"btc":json.dumps(btc) ,"eth":json.dumps(eth) ,"ltc":json.dumps(ltc) ,"bch":json.dumps(bch) }
        return dic[self.coin]
    def excel(self):

        r = json.loads(self.data())
        t ,c , o, l, h ,volume = r['t'][::-1], r['c'][::-1], r['o'][::-1] ,r['l'][::-1] ,r['h'][::-1] ,r['v'][::-1]

        for index, i in enumerate(t):
            d = datetime.fromtimestamp(i)
            d = str(d).replace("00:00:00","")
            hp ,lp, op, cp ,v= int(float(h[index])), int(float(l[index])), int(float(o[index])), int(float(c[index])), int(float(volume[index]))
            print(d, op, cp, hp, lp, v)
            self.table.write(index + 1,0,d)
            self.table.write(index + 1,1,op)
            self.table.write(index + 1,2,cp)
            self.table.write(index + 1,3,hp)
            self.table.write(index + 1,4,lp)
            self.table.write(index + 1,5,v)

        

if __name__ == "__main__":
    l = ["btc","eth","bch","ltc"]
    for i in l:
        bb = Btcbox(i)
        bb.excel()
    data.save("btcbox" + '.xls')